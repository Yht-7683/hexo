<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>开源秒杀项目miaosha解读 | Hexo</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="转载 17、开源秒杀项目miaosha解读">
<meta property="og:type" content="article">
<meta property="og:title" content="开源秒杀项目miaosha解读">
<meta property="og:url" content="http://www.2333nmsl.ml/2020/09/14/%E8%BD%AC%E8%BD%BD%2017%E3%80%81%E5%BC%80%E6%BA%90%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AEmiaosha%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="转载 17、开源秒杀项目miaosha解读">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images-cdn.shimo.im/ra4G5MqYNoAL2Zcn/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/qn00ocLaHTIyOZrd/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/FYJTeUk3eIouxfOa/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/2HNLYWsCyR0mg1Za/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/dtQXDrzYvsENlptr/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/21OZTxZ8bqICSGvR/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/6LGV1EG9S2E0BX88/image.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/hueJeZQgRiI6NqLP/081225378155003.png!thumbnail">
<meta property="og:image" content="https://images-cdn.shimo.im/DEG0S4I8I04lIGOm/081226107372877.png!thumbnail">
<meta property="article:published_time" content="2020-09-14T15:08:04.000Z">
<meta property="article:modified_time" content="2020-09-14T07:07:17.956Z">
<meta property="article:author" content="yht">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images-cdn.shimo.im/ra4G5MqYNoAL2Zcn/image.png!thumbnail">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 5.0.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/1.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/Yht-7683/" title="github">github</a>
					        
								<a class="mail" target="_blank" href="#" title="mail">mail</a>
					        
								<a class="qq" target="_blank" href="https://wpa.qq.com/msgrd?v=3&uin=434807683&site=qq&menu=yes" title="qq">qq</a>
					        
								<a class="weibo" target="_blank" href="https://weibo.com/" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/ASCII%E7%A0%81%E5%9B%BE/" style="font-size: 10px;">ASCII码图</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 20px;">Java基础</a> <a href="/tags/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">Java多线程</a> <a href="/tags/Redis/" style="font-size: 20px;">Redis</a> <a href="/tags/Websocket/" style="font-size: 10px;">Websocket</a> <a href="/tags/io/" style="font-size: 10px;">io</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/mybatis%E6%A1%86%E6%9E%B6/" style="font-size: 10px;">mybatis框架</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/renren-fast/" style="font-size: 15px;">renren-fast</a> <a href="/tags/spring-data/" style="font-size: 10px;">spring data</a> <a href="/tags/spring-security/" style="font-size: 10px;">spring security</a> <a href="/tags/springboot%E6%A1%86%E6%9E%B6/" style="font-size: 15px;">springboot框架</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 10px;">消息队列</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">计算机网络</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://a-cai.gitee.io/blog/">前端资料</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/1.gif" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Yht-7683/" title="github">github</a>
			        
						<a class="mail" target="_blank" href="#" title="mail">mail</a>
			        
						<a class="qq" target="_blank" href="https://wpa.qq.com/msgrd?v=3&uin=434807683&site=qq&menu=yes" title="qq">qq</a>
			        
						<a class="weibo" target="_blank" href="https://weibo.com/" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-转载 17、开源秒杀项目miaosha解读" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/09/14/%E8%BD%AC%E8%BD%BD%2017%E3%80%81%E5%BC%80%E6%BA%90%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AEmiaosha%E8%A7%A3%E8%AF%BB/" class="article-date">
  	<time datetime="2020-09-14T15:08:04.000Z" itemprop="datePublished">2020-09-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      开源秒杀项目miaosha解读
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="6-秒杀项目杂谈-xmind课程17预习-秒杀项目miaosha解读-xmind1-开源秒杀项目解读-xmind2-秒杀项目设计要点-xmind3-秒杀项目优化方向-xmind4-几张图-xmind5-jmeter-xmind什么是秒杀"><a href="#6-秒杀项目杂谈-xmind课程17预习-秒杀项目miaosha解读-xmind1-开源秒杀项目解读-xmind2-秒杀项目设计要点-xmind3-秒杀项目优化方向-xmind4-几张图-xmind5-jmeter-xmind什么是秒杀" class="headerlink" title="6_秒杀项目杂谈.xmind课程17预习_秒杀项目miaosha解读.xmind1_开源秒杀项目解读.xmind2_秒杀项目设计要点.xmind3_秒杀项目优化方向.xmind4_几张图.xmind5_jmeter.xmind什么是秒杀"></a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/yjGldVxYb2wTAkD0.xmind">6_秒杀项目杂谈.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/jj8N2UyKjBMYgyTI.xmind">课程17预习_秒杀项目miaosha解读.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/gSZYDpsyza4Xg357.xmind">1_开源秒杀项目解读.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/TuDUdg1JsuwDwr0o.xmind">2_秒杀项目设计要点.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/hB9fNKAeCHQyHWfN.xmind">3_秒杀项目优化方向.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/q5c9m6AAm0sZ82mx.xmind">4_几张图.xmind</a><a target="_blank" rel="noopener" href="https://uploader.shimo.im/f/nBQ60FROK9QXq3h9.xmind">5_jmeter.xmind</a>什么是秒杀</h2><p>秒杀场景一般会在电商网站举行一些活动或者节假日在12306网站上抢票时遇到。对于电商网站中一些稀缺或者特价商品，电商网站一般会在约定时间点对其进行限量销售，因为这些商品的特殊性，会吸引大量用户前来抢购，并且会在约定的时间点同时在秒杀页面进行抢购。</p>
<h2 id="秒杀系统场景特点"><a href="#秒杀系统场景特点" class="headerlink" title="秒杀系统场景特点"></a>秒杀系统场景特点</h2><p><strong>瞬时并发量大</strong></p>
<ul>
<li>秒杀时大量用户会在同一时间同时进行抢购，网站瞬时访问流量激增。</li>
</ul>
<p><strong>库存量少</strong></p>
<ul>
<li>秒杀一般是访问请求数量远远大于库存数量，只有少部分用户能够秒杀成功。</li>
</ul>
<p><strong>业务简单</strong></p>
<ul>
<li>秒杀业务流程比较简单，一般就是下订单减库存。<h2 id="秒杀项目设计要点"><a href="#秒杀项目设计要点" class="headerlink" title="秒杀项目设计要点"></a>秒杀项目设计要点</h2></li>
</ul>
<h3 id="设计理念"><a href="#设计理念" class="headerlink" title="设计理念"></a>设计理念</h3><p><strong>限流：</strong>鉴于只有少部分用户能够秒杀成功，所以要限制大部分流量，只允许少部分流量进入服务后端。</p>
<p><strong>削峰：</strong>对于秒杀系统瞬时会有大量用户涌入，所以在抢购一开始会有很高的瞬间峰值。高峰值流量是压垮系统很重要的原因，所以如何把瞬间的高流量变成一段时间平稳的流量也是设计秒杀系统很重要的思路。实现削峰的常用的方法有利用缓存和消息中间件等技术。</p>
<p><strong>异步处理：</strong>秒杀系统是一个高并发系统，采用异步处理模式可以极大地提高系统并发量，其实异步处理就是削峰的一种实现方式。</p>
<p><strong>内存缓存：</strong>秒杀系统最大的瓶颈一般都是数据库读写，由于数据库读写属于磁盘IO，性能很低，如果能够把部分数据或业务逻辑转移到内存缓存，效率会有极大地提升。</p>
<p><strong>可拓展：</strong>当然如果我们想支持更多用户，更大的并发，最好就将系统设计成弹性可拓展的，如果流量来了，拓展机器就好了。像淘宝、京东等双十一活动时会增加大量机器应对交易高峰。</p>
<h3 id="设计难点要点"><a href="#设计难点要点" class="headerlink" title="设计难点要点"></a>设计难点要点</h3><ul>
<li>对现有业务冲击</li>
<li>高并发应用负载高</li>
<li>突然增加网络与服务宽带</li>
<li>直接下单</li>
<li>控制商品页面购买按钮点亮</li>
<li>下单前置检查<h3 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h3></li>
</ul>
<ul>
<li><strong>前端：</strong></li>
</ul>
<p><strong>页面静态化**</strong>：**将活动页面上的所有可以静态的元素全部静态化，并尽量减少动态元素。通过CDN来抗峰值。</p>
<p><strong>禁止重复提交**</strong>：**用户提交之后按钮置灰，禁止重复提交。</p>
<ul>
<li><strong>服务端：</strong></li>
</ul>
<p><strong>（1）将请求尽量拦截在系统上游</strong>（不要让锁冲突落到数据库上去）。传统秒杀系统之所以挂，请求都压倒了后端数据层，数据读写锁冲突严重，并发高响应慢，几乎所有请求都超时，流量虽大，下单成功的有效流量甚小。以12306为例，一趟火车其实只有2000张票，200w个人来买，基本没有人能买成功，请求有效率为0。</p>
<p><strong>（2）充分利用缓存</strong>，秒杀买票，这是一个典型的读多写少的应用场景，大部分请求是车次查询，票查询，下单和支付才是写请求。一趟火车其实只有2000张票，200w个人来买，最多2000个人下单成功，其他人都是查询库存，写比例只有0.1%，读比例占99.9%，非常适合使用缓存来优化。</p>
<p><strong>（3）消息队列：</strong>消息队列可以削峰，将拦截大量并发请求，这也是一个异步处理过程，后台业务根据自己的处理能力，从消息队列中主动的拉取请求消息进行业务处理。</p>
<p><strong>（4）用户限流：</strong>在某一时间段内只允许用户提交一次请求，比如可以采取IP限流。</p>
<ul>
<li><strong>数据库层：</strong></li>
</ul>
<p>数据库层是最脆弱的一层，一般在应用设计时在上游就需要把请求拦截掉，数据库层只承担“能力范围内”的访问请求。所以，上面通过在服务层引入队列和缓存，让最底层的数据库高枕无忧。</p>
<p><img src="https://images-cdn.shimo.im/ra4G5MqYNoAL2Zcn/image.png!thumbnail" alt="图片"></p>
<p>（秒杀项目参考逻辑）</p>
<h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>。本项目是使用Redis作为缓存的一个秒杀项目实例。</p>
<ul>
<li>git地址：<a target="_blank" rel="noopener" href="https://gitee.com/1028125449/miaosha">https://gitee.com/1028125449/miaosha</a><h2 id="各个方案"><a href="#各个方案" class="headerlink" title="各个方案"></a>各个方案</h2></li>
</ul>
<h3 id="1-直接更新数据库："><a href="#1-直接更新数据库：" class="headerlink" title="1. 直接更新数据库："></a>1. 直接更新数据库：</h3><p>磁盘IO，开发机器实测2280 OPS，速度太低，当出现海量请求时会导致大量请求线程被阻塞，拒绝后续请求，拖垮整个tomcat和DB。</p>
<h3 id="2-redis-消息队列-更新数据库（秒杀和下单操作分离）"><a href="#2-redis-消息队列-更新数据库（秒杀和下单操作分离）" class="headerlink" title="2. redis+消息队列+更新数据库（秒杀和下单操作分离）"></a>2. redis+消息队列+更新数据库（秒杀和下单操作分离）</h3><ul>
<li>a、用户请求过来，将请求入消息队列；</li>
<li>b、消息处理，先减redis库存量，如果减库存成功，则生成下单token存入redis（设定有效期，比如2分钟之内下单有效），等待用户下单（这样就避免下单也面对大量并发）；如果减库存失败，则消息记录回到消息队列中，等待再次处理；</li>
<li>c、用户下单：判断token是否失效（比对时间）了，如果未失效则扣减库存（也可能扣减库存失败），生成订单；如果已经失效了，则redis库存增加1； 如何确保下单token过期了释放资格？JOB 每分钟扫token缓存，如果失效了的则清除调，并回馈redis缓存（redis库存+1）；</li>
<li>d、前端用户如何获知抢购成功了（获得了下单资格）：ajax轮训查询接口。 说明：为什么要采用轮询而不是用实时的websocket推送？经测试，一台tomcat最多能连接3000个websocket，如果类似抢购的大量用户抢购，机器肯定是扛不住这么多长连接的，而查询用户是否抢购成功也只是查询的redis，因此采用轮询是很好的选择。</li>
<li>e、<strong>为什么要秒杀和下单操作分离？</strong><ul>
<li>一方面，秒杀接口可以阻挡大部分并发流程，从而让下单操作错开并发高峰；</li>
<li>另一方面，可以让秒杀操作和下单操作从业务上相分离，使得秒杀操作可以独立于订单相关业务。<h3 id="3-防刷过滤器-redis-消息队列-更新数据库"><a href="#3-防刷过滤器-redis-消息队列-更新数据库" class="headerlink" title="3. 防刷过滤器+redis+消息队列+更新数据库"></a>3. 防刷过滤器+redis+消息队列+更新数据库</h3></li>
</ul>
</li>
</ul>
<p>针对第2方案中可能出现被辅助软件而已刷单的现象，可以增加过滤器：如果用户在指定时间内请求多少次，则认为是恶意用户，可以直接将该用户加入黑名单，并在后续的消息队列处理中不给黑名单的用户分配资格。</p>
<h3 id="技术运用"><a href="#技术运用" class="headerlink" title="技术运用"></a>技术运用</h3><ul>
<li>前端<ul>
<li>ajax</li>
<li>countdown</li>
</ul>
</li>
<li>后端<ul>
<li>redis作为缓存、消息队列<h3 id="逻辑处理"><a href="#逻辑处理" class="headerlink" title="逻辑处理"></a>逻辑处理</h3></li>
</ul>
</li>
</ul>
<p><img src="https://images-cdn.shimo.im/qn00ocLaHTIyOZrd/image.png!thumbnail" alt="图片"></p>
<p>（页面逻辑）</p>
<p><img src="https://images-cdn.shimo.im/FYJTeUk3eIouxfOa/image.png!thumbnail" alt="图片"></p>
<p>（后台接口逻辑）</p>
<p><img src="https://images-cdn.shimo.im/2HNLYWsCyR0mg1Za/image.png!thumbnail" alt="图片"></p>
<p>（消息队列异步处理流程图）</p>
<p><img src="https://images-cdn.shimo.im/dtQXDrzYvsENlptr/image.png!thumbnail" alt="图片"></p>
<p>（总流程时序图）</p>
<p><a target="_blank" rel="noopener" href="https://attachments-cdn.shimo.im/o6YihumJrr8jGhCT/%E7%A7%92%E6%9D%80%E8%AE%BE%E8%AE%A1%E6%97%B6%E5%BA%8F%E5%9B%BE.puml">秒杀设计时序图.puml</a></p>
<ol>
<li>秒杀详情页，等待秒杀开始</li>
<li>秒杀开始，获取秒杀链接</li>
<li>进入秒杀，限流，判断是否重复秒杀，把请求消息推入redis消息处理队列</li>
<li>消息处理器监听到消息后开始处理：<ol>
<li>监测黑名单</li>
<li>判断秒杀是否已结束</li>
<li>先减redis库存（占位）</li>
<li>生成下单token，存入redis供前端查询</li>
</ol>
</li>
<li>前端查询秒杀结果<ol>
<li>成功：显示下单按钮，用户使用token去下单</li>
</ol>
</li>
<li>用户下单</li>
<li>检查token有效性，检查库存</li>
<li>减库存，下单。（真正减库存）</li>
</ol>
<p>拦截器：</p>
<ul>
<li>恶意IP检测拦截器<ul>
<li>获取真实ip</li>
<li>匹配ip是否是正常ip，是否在黑名单库</li>
<li>使用redis增加ip的访问次数</li>
<li>超过限定次数就加入到黑名单库</li>
</ul>
</li>
<li>恶意用户检测拦截器<ul>
<li>同ip监测拦截<h3 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h3></li>
</ul>
</li>
</ul>
<p>商品库存信息预先生成，服务器启动时加载。</p>
<h3 id="请求过滤"><a href="#请求过滤" class="headerlink" title="请求过滤"></a>请求过滤</h3><p>入口只有活动开启前才能获得</p>
<p>入口恶意用户检测：多秒内多少次请求—可以记录最近10次请求时间，和前第九次请求时间对比</p>
<h3 id="实时限流器"><a href="#实时限流器" class="headerlink" title="实时限流器"></a>实时限流器</h3><ul>
<li>实时限流：限制正在处理的请求量（通过消息队列获取正在处理的请求数目）为库存的100倍请求（这个可自定义）；</li>
<li>如果出现了限流器满了，但仍然有库存的情况怎么办？直接拒绝请求，允许用户重新提交请求 ##请求减库存</li>
<li>请求通过了过滤之后，交给消息队列减库存+下单 ##消息队列处理</li>
<li>消息队列再次过滤请求是否是恶意的用户</li>
<li>否则，执行减库存+下单<h2 id="限流处理"><a href="#限流处理" class="headerlink" title="限流处理"></a>限流处理</h2></li>
</ul>
<p>限制用户维度访问频率</p>
<h2 id="需要考虑的恶意行为"><a href="#需要考虑的恶意行为" class="headerlink" title="需要考虑的恶意行为"></a>需要考虑的恶意行为</h2><ul>
<li>ip黑名单</li>
<li>用户黑名单<h2 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h2></li>
</ul>
<p><img src="https://images-cdn.shimo.im/21OZTxZ8bqICSGvR/image.png!thumbnail" alt="图片"></p>
<h2 id="redis的运用"><a href="#redis的运用" class="headerlink" title="redis的运用"></a>redis的运用</h2><p>Redis是一个分布式缓存系统，支持多种数据结构，我们可以利用Redis轻松实现一个强大的秒杀系统。作为缓存和消息队列使用</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>Redis incr 可以实现原子性的递增，可应用于高并发的秒杀活动、分布式序列号生成等场景。</p>
<p>Redis丰富的数据结构适用于多种场景，如消息队列。</p>
<h3 id="redis消息队列"><a href="#redis消息队列" class="headerlink" title="redis消息队列"></a>redis消息队列</h3><p>message-trunk是以redis为基础搭建的轻量级高性能消息总线（队列），和主流MQ相比使用起来更灵巧简便。</p>
<p>git地址：<a target="_blank" rel="noopener" href="https://gitee.com/1028125449/message-trunk">https://gitee.com/1028125449/message-trunk</a></p>
<p>使用方法：</p>
<ul>
<li>获取消息队列全局对象MessageTrunk（可以用spring注入），put入消息即可。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 获取MessageTrunk实例</span><br><span class="line">MessageTrunk mt &#x3D; (MessageTrunk) SpringBeanUtils.getBean(&quot;messageTrunk&quot;);</span><br><span class="line">Message&lt;DemoMessage&gt; message &#x3D; new Message&lt;DemoMessage&gt;(MessageType.DEMO_MESSAGE, new DemoMessage(value));</span><br><span class="line">&#x2F;&#x2F; 消息入MT</span><br><span class="line">mt.put(message);</span><br></pre></td></tr></table></figure></li>
<li>消息处理器：继承AbstarctMessageHandler抽象类。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class DemoHandler extends AbstarctMessageHandler&lt;DemoMessage&gt;&#123;</span><br><span class="line"> </span><br><span class="line"> private static Log logger &#x3D; LogFactory.getLog(DemoHandler.class);</span><br><span class="line"> public DemoHandler()&#123;</span><br><span class="line">  &#x2F;&#x2F; 说明该handler监控的消息类型</span><br><span class="line">  super(MessageType.DEMO_MESSAGE);</span><br><span class="line"> &#125;</span><br><span class="line"> &#x2F;**</span><br><span class="line">  * 监听到消息后处理方法</span><br><span class="line">  *&#x2F;</span><br><span class="line"> @Override</span><br><span class="line"> public void handle(DemoMessage message)&#123;</span><br><span class="line">        &#x2F;&#x2F; do handle</span><br><span class="line"> &#125;</span><br><span class="line"> @Override</span><br><span class="line"> public void handleFailed(DemoMessage obj)&#123;</span><br><span class="line">  &#x2F;&#x2F; handle failed</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3></li>
</ul>
<ul>
<li>哈希<ul>
<li>存储黑名单（ip，用户）</li>
<li>秒杀处理请求列表</li>
</ul>
</li>
<li>字符串<ul>
<li>增减库存</li>
<li>商品描述是否结束标志</li>
<li>下单token</li>
<li>…</li>
</ul>
</li>
<li>列表<ul>
<li>用户访问记录<h2 id="MySQL的存储过程"><a href="#MySQL的存储过程" class="headerlink" title="MySQL的存储过程"></a>MySQL的存储过程</h2></li>
</ul>
</li>
</ul>
<p>我们常用的操作数据库语言    SQL    语句在执行的时候需要要先编译，然后执行，而存储过程（    Stored Procedure    ）是一组为了完成特定功能的    SQL    语句集，经编译后存储在数据库中，用户通过指定存储过程的名字并给定参数（如果该存储过程带有参数）来调用执行它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FOUND_ROWS : 获取上一个select语句查询到的行数；</span><br><span class="line">ROW_COUNT : 获取上一条update， insert ，delete 影响的行数；</span><br></pre></td></tr></table></figure>
<p>MySQL存储过程创建的格式：CREATE PROCEDURE 过程名 ([过程参数    [,…]])<br>[特性 …] 过程体</p>
<p>mysql&gt; DELIMITER //</p>
<p>mysql&gt; CREATE PROCEDURE proc1(OUT s int)</p>
<p>-&gt; BEGIN</p>
<p>-&gt; SELECT COUNT(*) INTO s FROM user;</p>
<p>-&gt; END</p>
<p>-&gt; //</p>
<p>mysql&gt; DELIMITER ;</p>
<p>用call和你过程名以及一个括号，括号里面根据需要，加入参数，参数包括输入参数、输出参数、输入输出参数。</p>
<p><strong>参数：</strong></p>
<p>IN 输入参数:表示该参数的值必须在调用存储过程时指定，在存储过程中修改该参数的值不能被返回，为默认值</p>
<p>OUT 输出参数:该值可在存储过程内部被改变，并可返回</p>
<p>INOUT 输入输出参数:调用时指定，并且可被改变和返回</p>
<p>存储过程通常有以下优点：</p>
<p><strong>(1).存储过程增强了SQL语言的功能和灵活性</strong>。存储过程可以用流控制语句编写，有很强的灵活性，可以完成复杂的判断和较复杂的运算。</p>
<p><strong>(2).存储过程允许标准组件是编程</strong>。存储过程被创建后，可以在程序中被多次调用，而不必重新编写该存储过程的SQL语句。而且数据库专业人员可以随时对存储过程进行修改，对应用程序源代码毫无影响。</p>
<p><strong>(3).存储过程能实现较快的执行速度</strong>。如果某一操作包含大量的Transaction-SQL代码或分别被多次执行，那么存储过程要比批处理的执行速度快很多。因为存储过程是预编译的。在首次运行一个存储过程时查询，优化器对其进行分析优化，并且给出最终被存储在系统表中的执行计划。而批处理的Transaction-SQL语句在每次运行时都要进行编译和优化，速度相对要慢一些。</p>
<p><strong>(4).存储过程能过减少网络流量</strong>。针对同一个数据库对象的操作（如查询、修改），如果这一操作所涉及的Transaction-SQL语句被组织程存储过程，那么当在客户计算机上调用该存储过程时，网络中传送的只是该调用语句，从而大大增加了网络流量并降低了网络负载。</p>
<p><strong>(5).存储过程可被作为一种安全机制来充分利用</strong>。系统管理员通过执行某一存储过程的权限进行限制，能够实现对相应的数据的访问权限的限制，避免了非授权用户对数据的访问，保证了数据的安全。</p>
<h2 id="拓展杂谈"><a href="#拓展杂谈" class="headerlink" title="拓展杂谈"></a>拓展杂谈</h2><h2 id="1、缓存问题"><a href="#1、缓存问题" class="headerlink" title="1、缓存问题"></a>1、缓存问题</h2><p>作者：我一定会有猫的</p>
<p>链接：<a target="_blank" rel="noopener" href="https://juejin.im/post/5b604b9ef265da0f62639001">https://juejin.im/post/5b604b9ef265da0f62639001</a></p>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>缓存穿透是指查询一个一定不存在的数据，因为缓存中也无该数据的信息，则会直接去数据库层进行查询，从系统层面来看像是穿透了缓存层直接达到db，从而称为缓存穿透。</p>
<ul>
<li>布隆过滤器（guava BloomFilter）</li>
</ul>
<p>类似于哈希表的一种算法，用所有可能的查询条件生成一个bitmap，在进行数据库查询之前会使用这个bitmap进行过滤，如果不在其中则直接过滤，从而减轻数据库层面的压力。</p>
<ul>
<li>空值缓存 user108</li>
</ul>
<p>一种比较简单的解决办法，在第一次查询完不存在的数据后，将该key与对应的空值也放入缓存中，只不过设定为较短的失效时间，例如几分钟，这样则可以应对短时间的大量的该key攻击，设置为较短的失效时间是因为该值可能业务无关，存在意义不大，且该次的查询也未必是攻击者发起，无过久存储的必要，故可以早点失效。</p>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><p>在普通的缓存系统中一般例如redis、memcache等中，我们会给缓存设置一个失效时间，但是如果所有的缓存的失效时间相同，那么在同一时间失效时，所有系统的请求都会发送到数据库层，db可能无法承受如此大的压力导致系统崩溃。</p>
<ul>
<li>线程互斥</li>
</ul>
<p>只让一个线程构建缓存，其他线程等待构建缓存的线程执行完，重新从缓存获取数据才可以，每个时刻只有一个线程在执行请求，减轻了db的压力，但缺点也很明显，降低了系统的qps。</p>
<ul>
<li>交错失效时间</li>
</ul>
<p>这种方法时间比较简单粗暴，既然在同一时间失效会造成请求过多雪崩，那我们错开不同的失效时间即可从一定长度上避免这种问题，在缓存进行失效时间设置的时候，从某个适当的值域中随机一个时间作为失效时间即可。</p>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><p>缓存击穿实际上是缓存雪崩的一个特例，大家使用过微博的应该都知道，微博有一个热门话题的功能，用户对于热门话题的搜索量往往在一些时刻会大大的高于其他话题，这种我们成为系统的“热点“，由于系统中对这些热点的数据缓存也存在失效时间，在热点的缓存到达失效时间时，此时可能依然会有大量的请求到达系统，没有了缓存层的保护，这些请求同样的会到达db从而可能引起故障。击穿与雪崩的区别即在于击穿是对于特定的热点数据来说，而雪崩是全部数据。</p>
<ul>
<li>二级缓存</li>
</ul>
<p>对于热点数据进行二级缓存，并对于不同级别的缓存设定不同的失效时间，则请求不会直接击穿缓存层到达数据库。</p>
<ul>
<li>LRU算法<h2 id="2、应用限流"><a href="#2、应用限流" class="headerlink" title="2、应用限流"></a>2、应用限流</h2></li>
</ul>
<h3 id="计数器法"><a href="#计数器法" class="headerlink" title="计数器法"></a>计数器法</h3><ul>
<li>例如数据库连接池大小，线程池大小，秒杀并发数限制。全局请求数量达到一定阈值进行限流。<h3 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3></li>
</ul>
<ul>
<li>在上图中，整个红色的矩形框表示一个时间窗口，在我们的例子中，一个时间窗口就是一分钟。然后我们将时间窗口进行划分，比如图中，我们就将滑动窗口 划成了6格，所以每格代表的是10秒钟。每过10秒钟，我们的时间窗口就会往右滑动一格。每一个格子都有自己独立的计数器counter，比如当一个请求 在0:35秒的时候到达，那么0:30~0:39对应的counter就会加1。</li>
</ul>
<p><img src="https://images-cdn.shimo.im/6LGV1EG9S2E0BX88/image.png!thumbnail" alt="图片"></p>
<h3 id="漏桶算法"><a href="#漏桶算法" class="headerlink" title="漏桶算法"></a>漏桶算法</h3><ul>
<li>1）桶容量固定，固定速录流出</li>
<li>2）桶是空的，不流出</li>
<li>3）以任意速率流入桶，若超过桶容量，被丢弃</li>
</ul>
<p><img src="https://images-cdn.shimo.im/hueJeZQgRiI6NqLP/081225378155003.png!thumbnail" alt="图片"></p>
<h3 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h3><ul>
<li>1）存放固定令牌的桶100，生产令牌的速率固定 10/s</li>
<li>2）当令牌达到上限时候，产生的令牌被丢弃或拒绝</li>
<li>3）n个请求过来，拿n个令牌，若令牌不足，则请求被决绝或等待</li>
</ul>
<p><img src="https://images-cdn.shimo.im/DEG0S4I8I04lIGOm/081226107372877.png!thumbnail" alt="图片"></p>
<ul>
<li>应用<ul>
<li>Guava的RateLimiter令牌桶算法</li>
</ul>
</li>
</ul>
<p><strong><em>对比：令牌桶算法可一次拿n个令牌，说明允许突发请求。漏桶算法流出速率固定，说明会平滑处理突发请求</em></strong></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/14/%E8%BD%AC%E8%BD%BD%2018%E3%80%81%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6RabbitMq/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          消息中间件RabbitMq
        
      </div>
    </a>
  
  
    <a href="/2020/09/14/%E8%BD%AC%E8%BD%BD%2016%E3%80%81%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6t-io/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">网络编程框架t-io</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="ds-share share" data-thread-key="转载 17、开源秒杀项目miaosha解读" data-title="开源秒杀项目miaosha解读" data-url="http://www.2333nmsl.ml/2020/09/14/%E8%BD%AC%E8%BD%BD%2017%E3%80%81%E5%BC%80%E6%BA%90%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AEmiaosha%E8%A7%A3%E8%AF%BB/"  data-images="/img/1.gif" data-content="开源秒杀项目miaosha解读">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">
      	<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
        <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
      </ul>
      <div class="ds-share-icons-more">
      </div>
    </div>
 </div>
 





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2020 yht
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"rect":"opacity:0.8","log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>